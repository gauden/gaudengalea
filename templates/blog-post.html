{% extends "layout.html" %}

{% block title %}{{ this.title }} â€” {{ site.name }}{% endblock %}

{% block body %}
  <h1>{{ this.title }}</h1>

{# --- Series navigation (shown only on child posts) --- #}
{% set parent = this.parent %}
{% if parent and parent._model == 'blog-post' %}
  {# Find the series parts #}
  {% set parts = parent.children.order_by('order', 'title') %}
  {% set ns = namespace(prev=None, next=None, index=None, seen=False, last=None) %}

  {# one pass to find index/prev/next #}
  {% for p in parts %}
    {% if not ns.seen %}
      {% if p._id == this._id %}
        {% set ns.index = loop.index0 %}
        {% set ns.prev = ns.last %}
        {% set ns.seen = True %}
      {% else %}
        {% set ns.last = p %}
      {% endif %}
    {% elif ns.next is none %}
      {% set ns.next = p %}
    {% endif %}
  {% endfor %}

  {% set total = parts.count() %}
  {% if ns.index is not none %}
    <p  class="meta">
      {% if this.pub_date %}{{ this.pub_date|dateformat('d MMM YYYY') }}{% endif %}
      <span class="divider" style="display: inline-block; width: 2em;"></span>
      {% if ns.prev %}<a class="prev" href="{{ ns.prev|url }}">&larr;</a> {% endif %}
      Part {{ ns.index + 1 }} of {{ total }} in <a href="{{ parent|url }}">{{ parent.series }}</a> series
      {% if ns.next %}  <a class="next" href="{{ ns.next|url }}">&rarr;</a>{% endif %}
   </p>
  {% endif %}
  {% else %}
    {# No parent post, just show the date #}
    <p class="meta">
      {% if this.pub_date %}{{ this.pub_date|dateformat('d MMM YYYY') }}{% endif %}
    </p>
{% endif %}


{# --- Content --- #}
{{ this.body }}


{# --- Read More, listing sub-pages in a series --- #}
{% if this.children.count() %}
  <h3>Read more</h3>
    <ol>
      {% for part in this.children.order_by('order') %}
        <li>
          <a href="{{ part|url }}">{{ part.title }}</a>
          {% if part.summary %}<div class="part-summary">{{ part.summary }}</div>{% endif %}
        </li>
      {% endfor %}
    </ol>
{% endif %}


{# --- Series navigation (shown only on child posts) --- #}
{% set parent = this.parent %}
{% if parent and parent._model == 'blog-post' %}
  {% set parts = parent.children.order_by('order', 'title') %}
  {% set ns = namespace(prev=None, next=None, index=None, seen=False, last=None) %}

  {# one pass to find index/prev/next #}
  {% for p in parts %}
    {% if not ns.seen %}
      {% if p._id == this._id %}
        {% set ns.index = loop.index0 %}
        {% set ns.prev = ns.last %}
        {% set ns.seen = True %}
      {% else %}
        {% set ns.last = p %}
      {% endif %}
    {% elif ns.next is none %}
      {% set ns.next = p %}
    {% endif %}
  {% endfor %}

  {% set total = parts.count() %}
  {% if ns.index is not none %}
    <p  class="meta" style="margin-top: 3em;">
      {% if ns.prev %}<a class="prev" href="{{ ns.prev|url }}">&larr;</a> {% endif %}
      Part {{ ns.index + 1 }} of {{ total }} in <a href="{{ parent|url }}">{{ parent.series }}</a> series
      {% if ns.next %}  <a class="next" href="{{ ns.next|url }}">&rarr;</a>{% endif %}
   </p>
  {% endif %}
{% endif %}


{% endblock %}
